<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>DOOM QR</title><style>body{font-family:Arial,sans-serif;background:#121212;color:#e0e0e0;display:flex;flex-direction:column;align-items:center;margin:20px;overflow-x:hidden;line-height:1.6}h1{font-size:30px;color:#f5f5f5;margin-bottom:20px;letter-spacing:0.5px}#load-section{margin-bottom:20px}button{padding:12px 24px;background:#1e1e1e;color:#e0e0e0;border:1px solid #444;border-radius:6px;cursor:pointer;transition:background 0.3s,transform 0.2s}button:hover{background:#2a2a2a;transform:translateY(-2px)}button:active{background:#333;transform:translateY(0)}#status{font-size:18px;color:#d0d0d0;margin-bottom:10px}#progress-container{width:80%;max-width:400px;margin-bottom:20px;display:none}progress{width:100%;height:12px;border-radius:6px;background:#444;overflow:hidden}progress::-webkit-progress-bar{background:#444;border-radius:6px}progress::-webkit-progress-value{background:#4caf50;border-radius:6px}#currentQRContainer{display:none;text-align:center;margin-bottom:20px}#currentQRImage{max-width:200px;max-height:200px;display:block;margin:0 auto 10px;border:1px solid #444;border-radius:6px;box-shadow:0 4px 8px rgba(0,0,0,0.5)}#currentQRText{font-size:14px;color:#b0b0b0;min-height:20px;word-wrap:break-word}#gameCanvas{display:none;width:100%;max-width:800px;aspect-ratio:16/9;border:2px solid #555;background:#000;margin:0 auto;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.6)}@media (max-width:600px){button{padding:10px 18px;font-size:14px}#gameCanvas{max-width:100%}}</style></head><body><h1>QR DOOM</h1><div id="load-section"><button id="loadButton">Load QR Images</button></div><p id="status">Awaiting image load...</p><div id="progress-container"><progress id="progressBar" value="0" max="100"></progress></div><div id="currentQRContainer"><img id="currentQRImage" src="" alt="Current QR Code"><p id="currentQRText"></p></div><iframe id="gameCanvas"></iframe><script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script><script src="filenames.js"></script><script>(function(){"use strict";function openDB(){return new Promise(function(r,j){var o=indexedDB.open("DOOMQRCacheDB",1);o.onupgradeneeded=function(e){e.target.result.createObjectStore("qrCache",{keyPath:"key"})};o.onsuccess=function(e){r(e.target.result)};o.onerror=function(e){j("IndexedDB error: "+e.target.errorCode)}})}function getCache(db,k){return new Promise(function(r,j){var o=db.transaction("qrCache","readonly").objectStore("qrCache").get(k);o.onsuccess=function(e){r(e.target.result)};o.onerror=function(e){j("Cache get error: "+e.target.errorCode)}})}function setCache(db,k,v){return new Promise(function(r,j){var o=db.transaction("qrCache","readwrite").objectStore("qrCache").put({key:k,value:v});o.onsuccess=function(){r()};o.onerror=function(e){j("Cache set error: "+e.target.errorCode)}})}function processImg(url){return new Promise(function(r,j){var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){var c=document.createElement("canvas");c.width=o.width,c.height=o.height;var t=c.getContext("2d");t.drawImage(o,0,0);var d=t.getImageData(0,0,c.width,c.height),s=jsQR(d.data,d.width,d.height);if(!s||!s.data){j("No QR code found in "+url);return}var m=s.data.match(/^(\d+)\/(\d+)\|/);m?r({sequence:parseInt(m[1],10),total:parseInt(m[2],10),payload:s.data.substring(m[0].length),url:url}):r({sequence:1703,total:1703,payload:s.data,url:url})},o.onerror=function(){j("Failed to load image from "+url)},o.src=url})}function getDataURL(url){return new Promise(function(r,j){var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){var c=document.createElement("canvas");c.width=o.width,c.height=o.height,c.getContext("2d").drawImage(o,0,0),r(c.toDataURL())},o.onerror=function(){j("Failed to load image for Data URL from "+url)},o.src=url})}function loadGame(html){var b=new Blob([html],{type:"text/html"}),u=URL.createObjectURL(b);gameCanvas.src=u,statusText.textContent="Game loaded.",progressContainer.style.display="none",currentQRContainer.style.display="none",gameCanvas.style.display="block",document.title="DOOM QR"}function createWorker(){var s="importScripts('https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js');self.onmessage=function(e){var t=e.data,b=atob(t),o=new Uint8Array(b.length);for(var r=0;r<b.length;r++)o[r]=b.charCodeAt(r);var m=pako.inflate(o),n=new TextDecoder('utf-8').decode(m);postMessage(n)}";return new Worker(URL.createObjectURL(new Blob([s],{type:"application/javascript"})))}function asyncPool(limit,arr,fn){var i=0,ret=[],executing=[];function enqueue(){if(i===arr.length)return Promise.resolve();var item=arr[i++],p=Promise.resolve().then(function(){return fn(item)});ret.push(p);var e=p.then(function(){executing.splice(executing.indexOf(e),1)});executing.push(e);var r=Promise.resolve();if(executing.length>=limit)r=Promise.race(executing);return r.then(enqueue)}return enqueue().then(function(){return Promise.all(ret)})}var gameCanvas=document.getElementById("gameCanvas"),statusText=document.getElementById("status"),progressContainer=document.getElementById("progress-container"),progressBar=document.getElementById("progressBar"),currentQRContainer=document.getElementById("currentQRContainer"),currentQRImage=document.getElementById("currentQRImage"),currentQRText=document.getElementById("currentQRText"),loadButton=document.getElementById("loadButton");if(typeof window.imageURLs==="undefined"||!window.imageURLs.length){alert("Image URLs not found. Make sure filenames.js is loaded correctly.");return}var fullImageUrls=window.imageURLs.map(function(f){return"/DoomQR/"+f});function processImages(urls){if(!urls.length){alert("No image URLs provided.");return}statusText.textContent="Processing images... (0%)",progressContainer.style.display="block",currentQRContainer.style.display="block",document.title="0% DOOM QR";return openDB().then(function(db){var c=0;return asyncPool(5,urls,function(url){return getCache(db,url).then(function(s){return s&&s.value?s.value:processImg(url).then(function(res){return setCache(db,url,res).then(function(){return res})})}).then(function(res){c++;var pct=Math.round((c/urls.length)*100);progressBar.value=pct,statusText.textContent="Processing images... ("+pct+"%)",document.title=pct+"% DOOM QR",currentQRText.textContent="Processed "+c+" of "+urls.length+" images.";return(c%10===0||c===urls.length)?getDataURL(url).then(function(d){currentQRImage.src=d;return res}).catch(function(){return res}):res})}).then(function(results){statusText.textContent="Assembling data...";results=results.filter(function(r){return r});var tot=results[0].total;if(results.some(function(r){return r.total!==tot}))throw new Error("Mismatch in total QR chunk counts.");results.sort(function(a,b){return a.sequence-b.sequence});var fullData=results.map(function(r){return r.payload}).join("");statusText.textContent="Decompressing data...";var w=createWorker();w.onmessage=function(e){loadGame(e.data)};w.postMessage(fullData)})})}loadButton.addEventListener("click",function(){processImages(fullImageUrls).catch(function(e){console.error(e),alert("Error processing QR codes: "+e),statusText.textContent="Error occurred. Please try again.",document.title="DOOM QR"})})})();</script></body></html>